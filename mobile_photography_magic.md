# Фокусы мобильной фотографии

Почему изображения, получаемые на камеры современных смартфонов - это обман?

В данном материале описан путь от нажатия кнопки на экране до сохранения живого, насыщенного и вообще волшебной красоты изображения в галерее. Хотя такое ли оно **живое**?
## Техническое отступление
### В чем проблема мобильной съемки?


Посмотрим непосредственно на фотоматрицу - зрачок любого фотоустройства.
<div align="center">
<img src=img/size-comp.jpg/></div>

На изображении выше продемонстрированы размеры матриц популярных устройств. Площади для полнокадрового фотоаппарата и смартфона разнятся в целых **57 раз**, и хотя флагманские смартфоны сейчас уменьшили этот число до **30-20 раз**, разрыв все еще значительный.

Именно размер мобильных устройств является основной проблемой мобильной фотографии. 

Чуть углубимся в рождение изображения, чтобы разобраться. 

#### Фиксация света
Процесс создания фотографии начинается с записи света матрицей. Матрица имеет свое разрешение - число точек (пикселей), используемых для записи. 

Сейчас их число измеряется миллионами, например, 12 мегапикселей (МП) это примерно 12 миллионов точек, образующих единую картинку. 

При одинаковом разрешении матрицы, размер каждого пикселя в большом фотоаппарате будет многократно больше такового в небольшом телефоне. В маленький пиксель сможет попадать меньше света, а значит, при недостатке освещения, будут появляться шумы - искажения.
<div align="center">
<img src=img/noisy.jpeg/></div>

## Развитие мобильных камер
Первым полноценным телефоном с камерой принято считать Sharp J-SH04 из 2000 года. Вот так он снимал:

<div align="center">
<img src=img/sharp.jpg/></div>

Уже в 2005 Sony Erricson K850i начал делать такие фотографии:

<div align="center">
<img src=img/sek850i.jpg/></div>

В 2010 Nokia N8 получил заметно больший сенсор, качество изображения возрасло:

<div align="center">
<img src=img/nokian8.webp/></div>

На этом физическое развитие камер сильно замедлилось. Все вышепреведенные фотографии сделаны в идеальных условиях: отсутствует сильный контраст, достаточное количество света.

Конечно, за последнее десятилетие появились и свежие технические решения для смартфонов, например: **камера-перископ**, **стабилизация изображения** и даже **мобильная оптика с переменной диафрагмой**.

### Перископическая компоновка
Качественную систему линз невозможно поместить в тонкий корпус смартфона классическим путем. Однако, инженеры нашли обходной путь, используя компоновку перископа

<div align="center">
<img src=img/periscope.webp/></div>

Комбинируя несколько камер с алгоритмами, производители достигли действительно поразительных результатов

Возможности камеры *Samsung Galaxy S20 Ultra*:

<div align="center">
<img src=img/samsung-zoom.webp/></div>

### Стабилизация изображения
В середине прошлого десятилетия мобильные устройства стали оснащать оптической стабилизацией. Коротко - система линз движется так, чтобы скомпенсировать тряску камеры.

<div align="center">
<img src=img/optical-stab.webp/></div>

А в последние пару лет начали появляться устройства со стабилизацией на основе сдвига сенсора. Тут движется не вся оптическая система (довольно тяжелая), а только сам датчик изображения, подвешенный в магнитном поле. Большая маневренность позволила компенсировать микротряску и свести смазывание к минимуму.

<div align="center">
<img src=img/sensor-shift.webp/></div>

### Переменная диафрагма
В линейке Galaxy S9 Samsung впервые представила интересное техническое решение. Это позволило более точно регулировать световой поток в зависимости от условий съемки и получать более качественное изображение. Однако, технология из-за своей сложности (и соответствующей дороговизны) не прижилась.

<div align="center">
<img src=img/aperture.webp/></div>

### Преимущество телефонов перед фотоаппаратами
Парадокс, но именно возможность использовать телефон не только для фото позволила в значительной степени улучшить качество получаемого изображения. Десяток лет назад активно набирали популярность мобильные игры, требовавшие всё больших вычислительных мощностей.

Устанавливаемые для обработки игровой графики процессоры (системы на чипе, если быть точнее) отлично справлялись с данными камеры, позже к ним присоедились сопровождающие чипы обработки изображения (ISP), используемые только для съемки. Это и задало развитие области до наших дней.



#### Классические средства улучшения
Одними из первых доступных средств обработки изображений в реальном времени были HDR и NR (снижение шума), все дело в их вычислительной простоте
##### Широкий динамический диапазон (HDR)
Человеческий глаз способен захватывать одновременно очень широкий диапазон яркости. Сенсоры камер таким похвастаться не могут. На снимках с ярким солнцем обычно нечитаемы темные участки. 

Чтобы нивелировать подобный момент нужно сделать кадры (минимум два, но конечное число ограничено лишь здравым смыслом), содержащие информацию из темных и светлых участков, а затем склеить удачные кусочки изображения. 

<div align="center">
<img src=img/hdroff.jpg/></div>

<div align="center">
<img src=img/hdron.jpg/></div>

Еще более наглядно в анимации:

<div align="center">
<img src=img/hdrgif.webp/></div>

##### Уменьшение шума (Noise Reduction)
Крохотный размер пикселя, как было сказано ранее, заставляет фотографию "шуметь". Самые первые алгоритмы шумоподавления попросту усредняют содержимое соседних пикселей, убирая "зерна" шума. Это приводит к потере деталей, сопоставимой с уровнем зашумленности.

<div align="center">
<img src=img/noisy-deer.jpg/></div>

#### Продвинутые алгоритмы
Данные алгоритмы также довольно просты, но требуют бóльших вычислительных ресурсов, чем первая группа. Они появились в мобильных устройствах с дальнейшим ростом мощностей.

##### Определение границ и краевой контраст
Один из способов увеличить резкость изображения. Повышение контраста на переходах цветов отлично скрывает небольшие замутнения и промахи фокуса. Относится к постобработке.

<div align="center">
<img src=img/edge-contrasted.jpg/></div>

Очень часто этим эффектом злоупотребляют, чтобы на маленьком экране смартфона изображение выглядело резко. При открытии же на мониторе компьютера или телевизоре сразу бросается в глаза т.н. "перешарп" (англ. sharpness - четкость, резкость).

<div align="center">
<img src=img/peresharp.jpg/></div>

##### Коррекция оптических искажений
Линзы, особенно широкоугольные, вносят свои геометрические искажения в финальное изображение. Они ломают перспективу, делают картинку нереалистичной. 
Алгоритмы, призванные для борьбы с подобными дефектами, обычно настроены под конкретное устройство съемки.

<div align="center">
<img src=img/distortion.jpg/></div>


#### Непрерывная съемка
Мощный процессор и камера смартфона соединены скоростной магистралью, способной в режиме реального времени передавать изображения на обработку.

Съемка начинается не в момент нажатия клавиши затвора, наведения фокуса или появления человека в кадре. Съемка происходит **всегда**.

Изображения непрерывно записываются временным буфером в оперативной памяти устройства, а в момент нажатия клавиши затвора происходит выборка кадров **ДО** и **ПОСЛЕ**. 
Полученные данные объединяются мощными алгоритмами (насколько позволяют возможности устроства) и образуют единое целое, по-максимуму лишенное недостатков.
<div align="center">
<img src=img/pipeline2.jpg/></div>


Устройство постоянно меняет параметры съемки, в одну секунду совершая запись кадров с длинной и короткой выдержкой, высокой и низкой светочувствительностью. Четкие контуры из "шумных" снимков совмещаются со смазанными, но "чистыми".

<div align="center">
<img src=img/stanford-merge.jpg/></div>

Без возможности хранить такой огромный массив данных почти все описанные далее технологии были бы бесполезны.

####  Машинное обучение
*«Любая достаточно развитая технология неотличима от магии» © Артур Кларк*

Нейронные фильтры, обученные на миллионах фотографий модели сетей, молниеносное определение объекта съемки - все это скрыто для обывателя за завесой тайны. Именно тут было положено начало новой эпохи съемки.

В данной области наибольших успехов достигли два технологических гиганта - Google и Apple
##### Google HDR+ и Apple SmartHDR
С момента, когда телефоны смогли впервые склеивать пару изображений в HDR, прошло довольно много времени. Теперь смартфоны оперируют десятками изображений в секунду, извлекая лучший вариант для каждого участка фотографии. 
Все это проходит строгую цензуру обученной модели нейронной сети, которая корректирует цвета, увеличивает четкость и придает результату сбалансированный вид. Программное обеспечение анализирует общую картинку и находит подходящий заготовленный шаблон, будь то "закат", "горы" или нечто другое.

<div align="center">
<img src=img/hdrplus.webp/></div>

Модель без труда отделяет обработку отдельных людей на снимке, подбирая оптимальные параметры индивидуально. Происходит ретушь кожи, создание выразительных глаз и даже коррекция формы лица.

<div align="center">
<img src=img/person-selection.jpg/></div>

##### Super Res Zoom (Pixel Shifting)
Что если бы тряска рук не мешала, а напротив - помогала снимать?
Инженеры Google решили, что постоянное смещение - отличный источник дополнительных данных для обработки. Смартфон непрерывно анализирует поступающие кадры, чтобы буквально по пикселям собрать итоговое изображение, лишенное шумов и излишней размытости. Наибольшую эффективность алгоритм показал при программном приближении картинки, отсюда он и получил свое название.

<div align="center">
<img src=img/superreszoom.webp/></div>

##### DeepFusion
Часто мелкие структуры сливаются на фотографиях, компания Apple решила устранить эту проблему с помощью искусственного их воссоздания. 
После анализа изображения специально обученная нейронная сеть просто дорисовывает волосы, шерсть, элементы интерьера. Т.е. происходит замена некачественного изображения генеративным.

<div align="center">
<img src=img/deepfusion.jpg/></div>


### Заключение
Камеры современных смартфонов пришли к концепции "одного нажатия", где пользователь единым касанием пальца получает качественный результат. В прошлое уходят ручные настройки, беспокойство об условиях освещения, страх упустить важный кадр. Все чаще в чемоданах не находится места для даже небольшого фотоаппарата или видеокамеры.

Отбросив рутинные задачи, человеку проще сосредоточиться на творческой составляющей - создании композиции, идее снимка. 

За рамками данного текста остались некоторые отдаленные вещи, как, например, портретный и ночной режимы. Однако, исходя из описанного, довольно просто представить процесс создания подобных кадров. Думаю, найдется еще пара примеров.

Самое главное помнить - **лучшая камера та, которая у вас с собой**.



### Источники

apple.com

ai.googleblog.com

[(Stanford) Burst photography for high dynamic range and low-light imagingon mobile cameras](http://graphics.stanford.edu/papers/hdrp/hasinoff-hdrplus-sigasia16-preprint.pdf)